<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RunRT Results WebSocket Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #log { border: 1px solid #ccc; padding: 10px; height: 300px; overflow: auto; background: #fafafa; }
    input { padding: 6px; font-size: 14px; }
    button { padding: 6px 10px; margin-left: 6px; }
    .ok { color: #0a7; }
    .err { color: #c00; }
  </style>
</head>
<body>
  <h2>RunRT Results WebSocket Test</h2>
  <div>
    WebSocket URL: <input id="wsUrl" value="ws://localhost:8084/ws" size="40" />
    <button onclick="connectWs()">Connect</button>
    <button onclick="disconnectWs()">Disconnect</button>
  </div>
  <div style="margin-top:10px;">
    Poll ID: <input id="pollId" size="40" placeholder="f67d591b-...." />
    <button onclick="subscribePoll()">Subscribe</button>
  </div>
  <p>Status: <span id="status">Disconnected</span></p>
  <div id="log"></div>

  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
  <script>
    let client;
    let sub;
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');

    function log(msg, cls) {
      const div = document.createElement('div');
      if (cls) div.className = cls;
      div.textContent = msg;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function connectWs() {
      const url = document.getElementById('wsUrl').value;
      if (client && client.active) client.deactivate();

      client = new StompJs.Client({
        brokerURL: url,
        reconnectDelay: 3000,
        onConnect: () => {
          statusEl.textContent = 'Connected';
          statusEl.className = 'ok';
          log('CONNECTED', 'ok');
        },
        onStompError: (frame) => {
          log('STOMP error: ' + frame.headers['message'] + ' ' + frame.body, 'err');
        },
        debug: (str) => { log(str); }
      });

      client.activate();
      statusEl.textContent = 'Connecting...';
    }

    function disconnectWs() {
      if (sub) { sub.unsubscribe(); sub = null; }
      if (client) { client.deactivate(); }
      statusEl.textContent = 'Disconnected';
      statusEl.className = '';
      log('Disconnected');
    }

    function subscribePoll() {
      if (!client || !client.active) { log('Not connected', 'err'); return; }
      const pollId = document.getElementById('pollId').value.trim();
      if (!pollId) { log('Enter a pollId', 'err'); return; }
      const destination = `/topic/poll-results/${pollId}`;
      if (sub) sub.unsubscribe();
      sub = client.subscribe(destination, message => {
        log('MESSAGE ' + message.body, 'ok');
      });
      log('SUBSCRIBED ' + destination, 'ok');
    }
  </script>
</body>
</html>

